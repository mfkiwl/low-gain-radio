/* \file xcvr.c
 */
/*
    Original Programmed by William Harrington and Michael Mathis
 */

#include <stdbool.h>
#include "xcvr.h"

struct TRANSCEIVER xcvr_addrs =
{
	.RegFifo = 0x00,
	.RegOpMode = 0x01,
	.RegDataModul = 0x02,
	.RegBitrateMsb = 0x03,
	.RegBitrateLsb = 0x04,
	.RegFdevMsb = 0x05,
	.RegFdevLsb = 0x06,
	.RegFrfMsb = 0x07,
	.RegFrfMid = 0x08,
	.RegFrfLsb = 0x09,
	.RegOsc1 = 0x0A,
	.RegAfcCtrl = 0x0B,
	.RegLowBat = 0x0C,
	.RegListen1 = 0x0D,
	.RegListen2 = 0x0E,
	.RegListen3 = 0x0F,
	.RegVersion = 0x10,
	.RegPaLevel = 0x11,
	.RegPaRamp = 0x12,
	.RegOcp = 0x13,
	.RegLna = 0x18,
	.RegRxBw = 0x19,
	.RegAfcBw = 0x1A,
	.RegOokPeak = 0x1B,
	.RegOokAvg = 0x1C,
	.RegOokFix = 0x1D,
	.RegAfcFei = 0x1E,
	.RegAfcMsb = 0x1F,
	.RegAfcLsb = 0x20,
	.RegFeiMsb = 0x21,
	.RegFeiLsb = 0x22,
	.RegRssiConfig = 0x23,
	.RegRssiValue = 0x24,
	.RegDioMapping1 = 0x25,
	.RegDioMapping2 = 0x26,
	.RegIrqFlags1 = 0x27,
	.RegIrqFlags2 = 0x28,
	.RegRssiThresh = 0x29,
	.RegRxTimeout1 = 0x2A,
	.RegRxTimeout2 = 0x2B,
	.RegPreambleMsb = 0x2C,
	.RegPreambleLsb = 0x2D,
	.RegSyncConfig = 0x2E,
	.RegSyncValue1 = 0x2F,
	.RegSyncValue2 = 0x30,
	.RegSyncValue3 = 0x31,
	.RegSyncValue4 = 0x32,
	.RegSyncValue5 = 0x33,
	.RegSyncValue6 = 0x34,
	.RegSyncValue7 = 0x35,
	.RegSyncValue8 = 0x36,
	.RegPacketConfig1 = 0x37,
	.RegPayloadLength = 0x38,
	.RegNodeAdrs = 0x39,
	.RegBroadcastAdrs = 0x3A,
	.RegAutoModes = 0x3B,
	.RegFifoThresh = 0x3C,
	.RegPacketConfig2 = 0x3D,
	.RegAesKey1 = 0x3E,
	.RegAesKey2 = 0x3F,
	.RegAesKey3 = 0x40,
	.RegAesKey4 = 0x41,
	.RegAesKey5 = 0x42,
	.RegAesKey6 = 0x43,
	.RegAesKey7 = 0x44,
	.RegAesKey8 = 0x45,
	.RegAesKey9 = 0x46,
	.RegAesKey10 = 0x47,
	.RegAesKey11 = 0x48,
	.RegAesKey12 = 0x49,
	.RegAesKey13 = 0x4A,
	.RegAesKey14 = 0x4B,
	.RegAesKey15 = 0x4C,
	.RegAesKey16 = 0x4D,
	.RegTemp1 = 0x4E,
	.RegTemp2 = 0x4F,
	.RegTestLna = 0x58,
	.RegTestPLL = 0x5F,
	.RegTestDagc = 0x6F,
	.RegTestAfc = 0x71,
};

static struct TRANSCEIVER xcvr_defaults =
{
	.RegFifo = 0x00,
	.RegOpMode = 0x04,
	.RegDataModul = 0x00,
	.RegBitrateMsb = 0x1A,
	.RegBitrateLsb = 0x0B,
	.RegFdevMsb = 0x00,
	.RegFdevLsb = 0x52,
	.RegFrfMsb = 0xD4,
	.RegFrfMid = 0xC0,
	.RegFrfLsb = 0x00,
	.RegOsc1 = 0x41,
	.RegAfcCtrl = 0x00,
	.RegLowBat = 0x02,
	.RegListen1 = 0x92,
	.RegListen2 = 0xF5,
	.RegListen3 = 0x20,
	.RegVersion = 0x23,
	.RegPaLevel = 0x9F,
	.RegPaRamp = 0x09,
	.RegOcp = 0x1A,
	.RegLna = 0x08,
	.RegRxBw = 0x86,
	.RegAfcBw = 0x8A,
	.RegOokPeak = 0x40,
	.RegOokAvg = 0x80,
	.RegOokFix = 0x06,
	.RegAfcFei = 0x10,
	.RegAfcMsb = 0x00,
	.RegAfcLsb = 0x00,
	.RegFeiMsb = 0x00,
	.RegFeiLsb = 0x00,
	.RegRssiConfig = 0x02,
	.RegRssiValue = 0xFF,
	.RegDioMapping1 = 0x00,
	.RegDioMapping2 = 0x05,
	.RegIrqFlags1 = 0x80,
	.RegIrqFlags2 = 0x00,
	.RegRssiThresh = 0xFF,
	.RegRxTimeout1 = 0x00,
	.RegRxTimeout2 = 0x00,
	.RegPreambleMsb = 0x00,
	.RegPreambleLsb = 0x03,
	.RegSyncConfig = 0x98,
	.RegSyncValue1 = 0x00,
	.RegSyncValue2 = 0x00,
	.RegSyncValue3 = 0x00,
	.RegSyncValue4 = 0x00,
	.RegSyncValue5 = 0x00,
	.RegSyncValue6 = 0x00,
	.RegSyncValue7 = 0x00,
	.RegSyncValue8 = 0x00,
	.RegPacketConfig1 = 0x10,
	.RegPayloadLength = 0x40,
	.RegNodeAdrs = 0x00,
	.RegBroadcastAdrs = 0x00,
	.RegAutoModes = 0x00,
	.RegFifoThresh = 0x0F,
	.RegPacketConfig2 = 0x02,
	.RegAesKey1 = 0x00,
	.RegAesKey2 = 0x00,
	.RegAesKey3 = 0x00,
	.RegAesKey4 = 0x00,
	.RegAesKey5 = 0x00,
	.RegAesKey6 = 0x00,
	.RegAesKey7 = 0x00,
	.RegAesKey8 = 0x00,
	.RegAesKey9 = 0x00,
	.RegAesKey10 = 0x00,
	.RegAesKey11 = 0x00,
	.RegAesKey12 = 0x00,
	.RegAesKey13 = 0x00,
	.RegAesKey14 = 0x00,
	.RegAesKey15 = 0x00,
	.RegAesKey16 = 0x00,
	.RegTemp1 = 0x01,
	.RegTemp2 = 0x00,
	.RegTestLna = 0x1B,
	.RegTestPLL = 0x00,
	.RegTestDagc = 0x00,
	.RegTestAfc = 0x00,
};

bool xcvr_read_8bit_reg(uint8_t regaddr, uint8_t * d)
{
	return(spi0_read_8_poll(regaddr, d));
}


/* XTA,XTB connected to 32Mhz Crystal
 *  32/d = DIO5/CLKOUT Freq
 */
bool xcvr_set_outclk_div(XCVR_outdivs d)
{
	return(spi0_write_8_poll(xcvr_addrs.RegDioMapping2, d));
}


